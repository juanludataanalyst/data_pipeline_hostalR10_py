---
title: "EDA R10 Hostel "
output: html_document
date: "2024-08-29"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, message = FALSE, echo = FALSE}
## Loading libraries
library(tidyverse)
library(lubridate)
library(knitr)
library(ggrepel) ## Avoid superposition text in charts
```



```{r  , message = FALSE, echo = FALSE}
reservations <- read_csv("data/reservations.csv", show_col_types = FALSE)
room_reservations <- read_csv("data/room_reservations.csv", show_col_types = FALSE)
room_names <- read_csv("data/room_name.csv", show_col_types = FALSE)
customers_data <- read_csv("data/customers_data.csv", show_col_types = FALSE)
customers_reservations <- read_csv("data/customers_reservations.csv", show_col_types = FALSE)
```



```{r, echo = FALSE}
room_reservations_confirmed <- room_reservations %>% 
  left_join(reservations, by = c("id_reserva"="id")) %>% 
  filter(status == "Confirmed") %>% 
  mutate(start_date = lubridate::dmy(start_date),
         end_date = lubridate::dmy(end_date)) %>% 
  mutate(diff_days =  as.integer(end_date - start_date)) %>% 
  left_join(room_names, by = c("id_zak_room"="id")) %>% 
  filter(id_name_type != 'TBC')  %>% ## Borrar cuando actualice
  mutate(price_by_day = total_price/diff_days)  %>% 
  group_by(id_name_type) %>%
  mutate(
    mean_price = mean(price_by_day),
    sd_price = sd(price_by_day),
    Q1 = quantile(price_by_day, 0.25),
    Q3 = quantile(price_by_day, 0.75),
    median = quantile(price_by_day, 0.5),
    z_score = (price_by_day - mean_price) / sd_price,
    rango = 0.25 * quantile(price_by_day, 0.5)
  )  %>% 
   mutate( # if value 25% of deviation from median, adjust median (20% maximum disco)
    price_by_day = ifelse(
      abs(price_by_day) - median > rango,
      median,
      price_by_day
    ))
  
```

## Introduction


Empezamos viendo la ocupacion diaria del hostal. Se observa cierta estacionalidad y que muy pocas veces la ocupacion supera el 75% y nunca se llena, lo que nos da margen de mejora y optimizacion. 

La ocupacion media es solo del 54% y solo un x% de los dias supera el 75%.


```{r , echo = FALSE, fig.width=12,  fig.height = 6}
# Expandimos las reservas a nivel diario
reservas_diarias <- room_reservations_confirmed %>%
  select(id_name_type,id_zak_room,start_date,end_date,diff_days) %>% 
  uncount(diff_days , .id = "dia") %>%
  mutate(fecha = start_date + days(dia - 1)) %>% 
  filter(fecha <= '2024-07-31')

# Calculamos la capacidad total por tipo de habitación (asumimos que es constante)
capacidad_total <- reservas_diarias %>%
  group_by(id_name_type) %>% 
  summarise(capacidad_total = n_distinct(id_zak_room))

capacidad_total_general <- sum(capacidad_total$capacidad_total)


occupation_rate <- reservas_diarias %>%
  left_join(capacidad_total, by = "id_name_type") %>%
  group_by(fecha) %>%
    summarize(num_reservas = n()) %>% 
  mutate(ocupacion_porcentaje = num_reservas / capacidad_total_general )


ggplot(occupation_rate, aes(fecha,ocupacion_porcentaje)) +
  geom_line() +
  geom_hline(yintercept = mean(occupation_rate$ocupacion_porcentaje) ,color = "blue")+
  geom_point() +
  theme_minimal() + 
  scale_y_continuous(limits = c(0, 1), labels = scales::percent) +
  labs(x = "Date", y = "Occupation Rate (%)", title = "Occupation Rate by Date") 

```


Aqui se observa el patron de estacionalidad

```{r , echo = FALSE,  message = FALSE, fig.width=12,  fig.height = 6}


# Suponiendo que tienes un data frame llamado 'datos' con las columnas 'fecha' y 'ocupacion_porcentaje'

# Crear una nueva columna 'año' para agrupar los datos
occupation_rate$año <- format(as.Date(occupation_rate$fecha), "%Y")

ggplot(occupation_rate, aes(x = fecha, y = ocupacion_porcentaje)) +
  geom_line() +
  geom_smooth(method = "loess", span = 0.2) +
  geom_vline(xintercept = as.Date(paste0(unique(year(occupation_rate$fecha)), "-01-01")), 
             linetype = "dashed") +
  facet_wrap(~ año, ncol = 1, scales = "free_y") +
  labs(x = "Fecha", y = "Ocupación Porcentual") +
  theme_bw() +
  theme(panel.grid.major = element_line(color = "gray80"),
        panel.grid.minor = element_blank())+
  scale_y_continuous(limits = c(0, 1), labels = scales::percent)


```

Ahora vamos a ver la ocupacion por tipo de habitacion:


```{r, fig.width=12, fig.height=9, echo = FALSE,  message = FALSE}

# Contamos el número de reservas por día y tipo de habitación y calculamos el porcentaje de ocupación
ocupacion_por_dia <- reservas_diarias %>%
  group_by(fecha, id_name_type) %>%
  summarize(num_reservas = n()) %>%
  left_join(capacidad_total, by = "id_name_type") %>%
  mutate(ocupacion_porcentaje = num_reservas / capacidad_total )



 
 
 ggplot(ocupacion_por_dia %>%
         filter(id_name_type != 'TBC') 
        #%>%
         #  filter(grepl("beds", id_name_type))
         , aes(x = fecha, y = ocupacion_porcentaje, color = id_name_type)) +
  geom_smooth(span = 0.2, se = FALSE) +  # Suavizado con loess, sin bandas de confianza
  geom_line(alpha = 0.3) +  # Líneas originales con transparencia
  facet_wrap(~ id_name_type, ncol = 2, scales = "free_y") +
  labs(
    x = "Date",
    y = "Occupation Rate",
    color = "Room type",
    title = "Occupation Rate by room type"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    legend.text = element_text(size = 10),
    panel.spacing = unit(0.2, "lines"),
    strip.text = element_text(size = 10),
    panel.grid.major.y = element_line(color = "gray80"),
    panel.grid.minor.y = element_blank()
  )+
  scale_y_continuous(limits = c(0, 1), labels = scales::percent)


```


## How many days are full completed


```{r , echo = FALSE, message = FALSE}
days_completed <- ocupacion_por_dia %>% 
  mutate(completed = ifelse(ocupacion_porcentaje == 1,1,0)) %>% 
  ungroup() %>% 
  mutate(total_days = as.integer(max(fecha) - min(fecha))) %>% 
  group_by(id_name_type,total_days) %>% 
  summarise(days_completed = sum(completed) ) %>% 
  mutate(prop = days_completed/total_days)
  

kable(days_completed %>% 
        select(id_name_type,prop) %>% 
        mutate(prop = round(prop*100,2)) %>% 
        rename(room_type = id_name_type,days_completed_percentage = prop))

```

```{r , fig.width=12, fig.height=9, echo = FALSE,  message = FALSE}

## Porcentaje ocupacion todas las compartidas juntas

shared_occupation <- ocupacion_por_dia %>% 
  filter(grepl("beds", id_name_type)) %>% 
  group_by(fecha) %>% 
  summarise(occupation = sum(num_reservas)) %>% 
  mutate(prop = occupation/(8+8+6+4))
  

ggplot(shared_occupation, aes(fecha,occupation)) +
  geom_line() +
  geom_hline(yintercept = c(8, 16, 22,26), color = "gray")+
  theme_minimal() +
  labs(title = "Total reservations number in shared rooms", x="Date", y = "People") +
  # Agregar texto a las líneas
#  annotate("text", x = 11, y = c(1, -1), label = c("Línea 1", "Línea 2"), color = c("red", "blue")) +
  # Personalizar el tema
  theme_minimal() +
  scale_y_continuous(breaks = c(0,8, 16, 22, 26),
                     limits = c(0, 26),
                      labels = c(0, "(8 beds full)    8  ", "(Second 8 beds full)   16", "(8+6 beds full)   22", "(8+6+4 beds full)     26")) +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank()
  )

```



RevPar by date
```{r}
RevPar <- room_reservations_confirmed %>% 
  uncount(diff_days , .id = "dia") %>%
  mutate(fecha = start_date + days(dia - 1)) %>% 
  filter(fecha <= '2024-07-31') %>% 
  group_by(fecha) %>% 
  summarise(n_rooms = n(),
            total_revenue = sum(price_by_day)) %>% 
  mutate(occupation = n_rooms/capacidad_total_general,
    adr_day = total_revenue/n_rooms) %>% 
  mutate(RevPar_day = adr_day * occupation)
  
  
  
  ggplot(RevPar, aes(fecha,RevPar_day)) +
    geom_line() +
  geom_hline(yintercept = mean(RevPar$RevPar_day) ,color = "blue")+
  geom_point() +
  theme_minimal() 
  
    ggplot(RevPar, aes(RevPar_day)) +
 
  geom_density() 
 
  


```



RevPar by date and room_type
```{r}

RevPar_room_type <- room_reservations_confirmed %>% 
  uncount(diff_days , .id = "dia") %>%
  mutate(fecha = start_date + days(dia - 1)) %>% 
  filter(fecha <= '2024-07-31') %>% 
  group_by(fecha,id_name_type) %>% 
  summarise(n_rooms = n(),
            total_revenue = sum(price_by_day)) %>% 
  left_join(capacidad_total, by = "id_name_type")%>% 
  mutate(occupation = n_rooms/capacidad_total,
    adr_day = ifelse( id_name_type == 'shared 4 beds'| id_name_type == 'shared 6 beds'  , total_revenue,
                      ifelse(id_name_type == 'shared 8 beds', total_revenue/2,
                      
      
      total_revenue/n_rooms
    ))
    ) %>% 
  mutate(RevPar_day = adr_day * occupation)



 ggplot(RevPar_room_type  
                    , aes(x = fecha, y = RevPar_day,color = id_name_type)) +
        geom_line() +
    facet_wrap(~ id_name_type, ncol = 2)   + 
   labs(
         x = "Fecha",
         y = "RevPar",
         color = "Tipo de habitacion",
         title = "Evolución del RevPar por Tipo de Habitación"
      )+
  theme_minimal() +
  theme(
    legend.position = "bottom",
    legend.text = element_text(size = 10),
     panel.spacing = unit(0.2, "lines"),
    strip.text = element_text(size = 10),
    #panel.grid.major.y = element_line(color = "gray80"),
  #  panel.grid.minor.y = element_blank()
  ) 

 ggplot(RevPar_room_type  %>% 
          filter(id_name_type == 'shared 4 beds' | id_name_type == 'double privated bathroom')
                    , aes(x = fecha, y = RevPar_day,color = id_name_type)) +
        geom_line() +
    
   labs(
         x = "Fecha",
         y = "RevPar",
         color = "Tipo de habitacion",
         title = "Evolución del RevPar por Tipo de Habitación"
      )





```

```{r echo = FALSE}

occupation_rate_by_room <- room_reservations_confirmed %>% 
  mutate(total_days = as.integer(max(start_date) - min(start_date) )) %>% 
  group_by(total_days,id_name_type) %>% 
  summarise(days = sum(diff_days),
            nrooms = n_distinct(id_zak_room),
            total_price = sum(total_price),
            mediana = median(price_by_day),
            media = mean(price_by_day)
            ) %>% 
  mutate(avg_price = total_price/days,
         occupation_rate = days/(total_days*nrooms)) %>% 
  mutate(RevPar = ifelse( id_name_type == 'shared 4 beds'| id_name_type == 'shared 6 beds',occupation_rate*avg_price*nrooms, 
                          ifelse(id_name_type == 'shared 8 beds',occupation_rate*avg_price*(nrooms/2),
                            occupation_rate*avg_price)))

```
 
 

Stay duration by room type

```{r}
duration <- reservas_diarias %>% 
  group_by(id_zak_room,id_name_type,start_date) %>% 
  summarise(dias = max(dia), .groups = "drop") %>% 
  mutate(dias = ifelse(dias > 5, 5,dias)) %>% 
  group_by(dias,id_name_type) %>% 
  summarise(estancias = n(), .groups = "drop") %>% 
  group_by(id_name_type) %>% 
  mutate(total_estancias = sum(estancias)) %>% 
  mutate(prop = estancias/total_estancias)%>%
  arrange(dias) %>%
  mutate(prop_acumulada = cumsum(prop))


ggplot(duration%>% filter(dias < 5), aes(dias,prop_acumulada ,fill = id_name_type)) +
   geom_area(alpha = 0.2,position = "dodge") +
  scale_fill_brewer(palette = "Set2", name = "Tipo de habitación") +
  labs(x = "Duración de la estancia (días)",
       y = "Proporción acumulada de estancias",
       title = "Evolución de la proporción de estancias por tipo de habitación") +
  theme_minimal() +
  theme(legend.position = "bottom")

ggplot(duration, aes(dias,prop ,fill = id_name_type)) +
  geom_col(position = "dodge")  +
  scale_color_discrete(name = "Tipo de habitación") +
  scale_y_continuous(limits = c(0, 1), labels = scales::percent)



```
 
 
 
 Avg price vs occupation rate by room
```{r}

# Calcula la pendiente ajustada
max_avg_price <- max(occupation_rate_by_room$media)
slope <- 1 / max_avg_price  # Si occupation_rate varía de 0 a 1

# Genera el gráfico con la línea ajustada desde el origen
ggplot(occupation_rate_by_room, aes(media, occupation_rate, color = as.factor(id_name_type))) +  
  geom_abline(slope = slope, intercept = 0, linetype = "dashed", color = "black") +  # Línea ajustada desde (0, 0)
  geom_point(size = 3) +  # Luego, añade los puntos
    geom_text_repel(aes(label = paste0("RevPar: ", round(RevPar, 0), " COP")), 
                  size = 3, 
                  box.padding = 0.5, point.padding = 0.5) + 
  # geom_text(aes(label = paste0("RevPar ", round(RevPar, 0)," COP")), vjust = -1, size = 2.5) + 
  labs(x = "Precio promedio (COP)", y = "Proporción ocupada", color = "Tipo de habitación") + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  scale_color_discrete(name = "Tipo de habitación") +
  scale_y_continuous(limits = c(0, 1), labels = scales::percent)+
scale_x_continuous(limits = c(0, 150000))



```







Revenue proportion by room_type

```{r}

revenue_by_room_type <- room_reservations_confirmed %>% 
  group_by(id_name_type) %>% 
  summarise(room_revenue = sum( price_by_day*diff_days )) %>% 
  mutate(total_revenue = sum(room_revenue)) %>% 
  mutate(prop = room_revenue/total_revenue)


ggplot(revenue_by_room_type, aes(fct_reorder(id_name_type, -prop),prop))+
  geom_col()+ 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+ 
  scale_y_continuous(limits = c(0, 1), labels = scales::percent) +  
   labs(
         x = "Date",
         y = "Proportion",
         title = "Revenue proportion by room_type"
      )



```





```{r}



```

